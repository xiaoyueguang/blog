# 前端安全之XSS, CSRF, 网络挟持

随着越来越多的用户进入互联网, 信息安全已成为企业的最为关注的焦点之一. 本篇文章从传统的`XSS`, `CSRF`进行介绍以及预防.

## XSS

`XSS`, 又名**跨站脚本攻击**(`Cross Site Scripting`), 是一种安全漏洞, 攻击者通过该漏洞, 往网站里注入恶意代码(比如`Javascript`), 被攻击者访问网站时, 会自动运行该脚本, 从而导致自身信息泄露.

`XSS`攻击分为三种:

1. 存储型XSS
2. 反射型XSS
3. 基于DOM的XSS

### 存储型XSS

用户通过客户端提交的数据, 服务端接收后保存, 并显示到其他用户的页面上. 如果用户提交的数据包含恶意脚本代码, 服务端或客户端没有进行编码转换或过滤, 就会行成`XSS`攻击, 这种形式的XSS叫做**存储型XSS**.

### 反射型XSS

用户通过客户端提交的数据, 服务端不经过存储, 而是直接显示到结果页面中. 如果用户提交的数据包含恶意代码, 服务端或客户端没有进行编码转换或过滤, 也会造成`XSS`攻击, 这种形式的XSS叫做**反射型XSS**

### 基于DOM的XSS

基于DOM的XSS, 既可以是存储型XSS, 也可以是反射型XSS, 不取决于输出环境, 而是取决于输出位置. 比如说`DOM`的一些`onclick`, `onerror`之类.

[查看源码](https://github.com/xiaoyueguang/security)

### 如何防范XSS

通过上面的DEMO, 可发现XSS基本都是通过输出用户传入的恶意代码来实现. 因此我们要对输出的部分以及输入的时候进行一些限制即可.

* 移除用户自定义输入的script标签.
* 移除用户自定义输入的绑定on事件.

## CSRF

CSRF, 又名**跨站请求伪造**(`Cross-Site Request Forgery`). 攻击者诱导用户进入第三方页面, 在第三方网站中, 向被攻击者网站发送跨站请求, 从而获取到用户在被攻击网站上已获得注册凭证, 利用这个凭证, 绕过后台的用户验证, 达到冒充用户, 并在网站上进行操作的目的.

我们通过一个DEMO来了解下如何实现`CSRF`. 从定义中可知攻击者主要是为了获取一个注册凭证, 比如说类似`cookie`之类. 因此通过`node`来启动两个服务器, 分别模拟正常支付网站以及假网站. 在假的网站上诱导用户操作, 从而实现转账功能.

攻击步骤:

1. 用户在正常页面登录
2. 在第三方页面上添加一个`form`表单
3. 用户通过点击该表单, 跳转到正常页面, 从而实现一系列操作, 比如转账或XSS等.

[预览视频](https://ray-static.oss-cn-beijing.aliyuncs.com/security-csrf.mp4)

[查看源码](https://github.com/xiaoyueguang/security)

### 如何防范CSRF

* 通过`form`或其他方式去访问被攻击页面的, 他的`Referer`会指向攻击者的页面, 因此可在被攻击页面上通过`Referer`判断来源是否可靠.
* 通过API接口访问的, 还需要限制`Access-Control-Allow-Origin`字段.
* 生成一个随机的`csrf token`, 攻击者无法获得该`token`, 被攻击页面通过验证该`token`来判断是否有效.
* 也可以通过一个短信验证码或验证码, 来确保请求来自可信任的页面.(短信验证码或验证码基本会通过用户当前访问的页面生成, 确保提交后, 服务端能根据该验证码来判断来源是否一致)

## 网络挟持

网络挟持主要有DNS挟持以及HTTP挟持.

要理解网络挟持, 首先先了解浏览器是如何通过一个域名向服务器请求内容的, 流程如下

1. 在浏览器输入域名, 浏览器用域名, 经过ISP(互联网服务提供商)去DNS服务器(一串IP地址)查询对应的IP地址.
2. 拿到IP地址后, 再次经过ISP(互联网服务提供商)请求该IP, 获得内容后并通过ISP返回到浏览器端展现.

DNS挟持, 直接通过污染DNS服务器, 导致用户去DNS取到的IP地址不正确, 从而引导用户跳转到第三方页面.

HTTP挟持, 用户访问网站时, 会经过ISP, 如果用户通过HTTP访问, 这会导致用户跟服务器之间的数据都是明文传输, ISP或其他中间人会很容易去窜改数据, 从而达到注入等. 可通过开启HTTPS服务, 保证两端数据加密传输即可.

## 总结

大部分的安全都可以通过服务端设置即可避免, 比如XSS, CSRF, HTTP挟持等. 而DNS挟持比较复杂, 一般需要用户自己手动去保证安全, 服务器被污染后甚至用户什么也做不了.